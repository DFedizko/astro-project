---
import type { ImageMetadata } from 'astro';
import Image from 'astro/components/Image.astro';

type Props = {
	src: ImageMetadata | Promise<{
        default: ImageMetadata;
    }>;
	blurSrc: string;
	alt: string;
	width: number | `${number}`;
	height: number | `${number}`;
	loading?: "lazy" | "eager";
	quality?: "high" | "low" | "max" | "mid";
	format?: "avif" | "jpeg" | "jpg" | "png" | "svg" | "webp";
	priority?: boolean;
}

const { 
	src,
	blurSrc,
	alt,
	width,
	height,
	loading,
	quality,
	format,
	priority
} = Astro.props;
---

<div
	class=`progressive-wrapper relative w-[${width}px] h-[${height}px]`
>
	<div
		id="blur-placeholder"
		class="absolute inset-0 bg-cover bg-center blur-2xl transition-opacity
			duration-300"
		style=`background-image: url(${blurSrc})`
	></div>
	<Image
		src={src}
		alt={alt}
		width={width}
		height={height}
		id="real-img"
		loading={loading ?? "eager"}
		format={format ?? "avif"}
		quality={quality ?? "mid"}
		priority={priority ?? false}
		class="w-full h-full object-cover opacity-0 transition-opacity duration-300"
	/>
</div>

<script is:inline>
	// @ts-nocheck
	(() => {
		const img = document.getElementById("real-img");
		const placeholder = document.getElementById("blur-placeholder");

		const onLoad = () => {
			img.classList.remove("opacity-0");
			img.classList.add("opacity-100");
			placeholder.classList.add("opacity-0");
			placeholder.addEventListener("transitionend", () => {
				placeholder.style.display = "none";
			});
		}

		if (img.complete) {
			onLoad();
		} else {
			img.addEventListener("load", onLoad);
		}
	})();
</script>